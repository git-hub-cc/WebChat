
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPMC</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="PPMC: 一款功能丰富的 AI 角色扮演聊天平台。基于 WebRTC、JavaScript 和 Spring Boot 构建，提供文本/语音/视频/屏幕共享、文件传输以及支持 TTS 和主题化的动态 AI 助手。Feature-rich AI Character Chat Platform built with WebRTC, JS & Spring Boot, offering text/voice/video/screen sharing, file transfer, and dynamic AI assistants with TTS & theming.">
    <meta name="keywords" content="PPMC, WebRTC, AI Chat, Character Chat, Role-playing, JavaScript, Spring Boot, WebSocket, Real-time Communication, Video Call, Audio Call, Screen Sharing, TTS, Text-to-Speech, Theming, Genshin Impact, Xian Ni, Battle Through the Heavens, Crayon Shin-chan, Delicious in Dungeon, Jujutsu Kaisen, AI聊天, 角色扮演, 实时通讯, 文本转语音, 原神, 仙逆, 斗破苍穹, 蜡笔小新, 迷宫饭, 咒术回战, 即时通讯, AI助手">
    <meta name="author" content="git-hub-cc">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://175.178.216.24/">
    <meta property="og:title" content="PPMC - AI Character Chat Platform">
    <meta property="og:description" content="PPMC: 一款功能丰富的 AI 角色扮演聊天平台。基于 WebRTC、JavaScript 和 Spring Boot 构建，提供文本/语音/视频/屏幕共享、文件传输以及支持 TTS 和主题化的动态 AI 助手。Feature-rich AI Character Chat Platform built with WebRTC, JS & Spring Boot, offering text/voice/video/screen sharing, file transfer, and dynamic AI assistants with TTS & theming.">
    <meta property="og:image" content="https://175.178.216.24/img/desktop/img.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://175.178.216.24/">
    <meta property="twitter:title" content="PPMC - AI Character Chat Platform">
    <meta property="twitter:description" content="PPMC: 一款功能丰富的 AI 角色扮演聊天平台。基于 WebRTC、JavaScript 和 Spring Boot 构建，提供文本/语音/视频/屏幕共享、文件传输以及支持 TTS 和主题化的动态 AI 助手。Feature-rich AI Character Chat Platform built with WebRTC, JS & Spring Boot, offering text/voice/video/screen sharing, file transfer, and dynamic AI assistants with TTS & theming.">
    <meta property="twitter:image" content="https://175.178.216.24/img/desktop/img.png">
    <!-- End of SEO Meta Tags -->

    <link rel="stylesheet" href="css/基础/core.css">
    <link rel="stylesheet" href="css/基础/sidebar.css">
    <link rel="stylesheet" href="css/基础/chat-area.css">
    <link rel="stylesheet" href="css/基础/details-panel.css">
    <!-- 主题特定 CSS 占位符, href 会被 ThemeLoader.init 动态填充 -->
    <link id="theme-stylesheet" rel="stylesheet" href="css/动漫/原神-浅色.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
<div class="app-container">
    <!-- 左侧边栏 (导航) -->
    <aside class="sidebar-nav" id="sidebarNav">
        <header class="sidebar-header">
            <button class="menu-btn" id="mainMenuBtn" title="菜单">☰</button>
            <label for="chatSearchInput" class="visually-hidden">搜索聊天</label><input type="search" class="search-bar" id="chatSearchInput" placeholder="搜索...">
        </header>
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab-target="all-chats" id="tabAllChats">全部</button>
            <button class="nav-tab" data-tab-target="contacts-list" id="tabContacts">联系人</button>
            <button class="nav-tab" data-tab-target="groups-list" id="tabGroups">群组</button>
        </nav>
        <div class="chat-list-container">
            <ul id="chatListNav">
                <!-- 聊天项目将由 JS 在此处填充 -->
                <li class="chat-list-item-empty">暂无聊天。</li>
            </ul>
        </div>
        <button class="new-chat-fab" id="newChatFab" title="新聊天/群组">+</button>
    </aside>
    <!-- 主聊天区 -->
    <main class="chat-area" id="chatArea">
        <div class="chat-area-content">
            <header class="chat-header-main">
                <button class="back-to-list-btn" id="backToListBtn" title="返回列表">←</button>
                <div class="chat-info-main">
                    <div class="chat-avatar-main" id="currentChatAvatarMain"></div>
                    <div class="chat-details-main-header">
                        <h1 class="chat-title-main" id="currentChatTitleMain">选择一个聊天</h1>
                        <div class="chat-status-main" id="currentChatStatusMain"></div>
                    </div>
                </div>
                <div class="chat-actions-main">
                    <button class="header-action-btn" id="videoCallButtonMain" title="视频通话" disabled>📹</button>
                    <button class="header-action-btn" id="audioCallButtonMain" title="语音通话" disabled>🎤</button>
                    <button class="header-action-btn" id="screenShareButtonMain" title="屏幕共享" disabled>🖥️</button>
                    <button class="header-action-btn" id="peopleLobbyButtonMain" title="人员大厅">👥</button>
                </div>
            </header>

            <section class="no-chat-selected" id="noChatSelectedScreen">
                <div class="logo-placeholder">💬</div>
                <h2>PPMC</h2>
                <p>从列表中选择聊天开始，或创建一个新聊天。</p>
                <p id="connectionStatusGlobal" class="status-indicator">状态: <span id="connectionStatusText">初始化中...</span></p>
            </section>
            <div class="chat-messages-container" id="chatBox">
                <!-- 消息将在此处填充。noChatSelectedScreen 不再是其子元素。 -->
            </div>

            <footer class="chat-input-container">
                <div id="filePreviewContainer" class="file-preview-input"></div>
                <div id="audioPreviewContainer" class="audio-preview-input"></div>
                <div class="input-row">
                    <button class="icon-btn attach-btn" id="attachBtnMain" title="附加文件" disabled>📎</button>
                    <button class="icon-btn screenshot-main-btn" id="screenshotMainBtn" title="截图" disabled>📸</button>
                    <button class="icon-btn emoji-sticker-btn" id="emojiStickerBtn" title="表情/贴图" disabled>😀</button>
                    <input type="file" id="fileInput" class="visually-hidden">
                    <label for="messageInput" class="visually-hidden">消息输入框</label><textarea id="messageInput" placeholder="输入消息..." disabled></textarea>
                    <button class="icon-btn send-btn" id="sendButtonMain" title="发送" disabled>➤</button>
                    <button class="icon-btn record-btn" id="voiceButtonMain" title="录制语音" disabled>🎙️</button>
                </div>
                <div id="emojiStickerPanel" class="emoji-sticker-panel">
                    <nav class="menu-tabs">
                        <button class="menu-tab-item active" data-tab="emoji">Emoji</button>
                        <button class="menu-tab-item" data-tab="sticker">贴图</button>
                    </nav>
                    <div id="emojiTabContent" class="menu-tab-content active">
                        <div id="emojiGrid" class="emoji-grid">
                            <!-- Emojis will be populated by JS -->
                        </div>
                    </div>
                    <div id="stickerTabContent" class="menu-tab-content">
                        <div id="stickerGrid" class="sticker-grid">
                            <!-- Stickers will be populated by JS -->
                        </div>
                        <button id="addStickerBtn" class="btn btn-secondary">添加贴图</button>
                        <input type="file" id="stickerInput" accept="image/png, image/jpeg, image/gif, image/webp" class="visually-hidden">
                    </div>
                </div>
            </footer>
        </div>
        <!-- 为拖放功能添加 -->
        <div class="drop-overlay" id="dropOverlay">
            <div class="drop-overlay-text">拖拽文件到此处发送</div>
        </div>
    </main>

    <!-- 右侧详情面板 -->
    <aside class="details-panel" id="detailsPanel">
        <header class="details-header">
            <h3 id="detailsPanelTitle">聊天信息</h3> <!-- 此标题会被 JS 动态更改 -->
            <button class="icon-btn close-details-btn" id="closeDetailsBtnMain" title="关闭详情">✕</button>
        </header>
        <div class="details-content" id="detailsPanelContent">
            <section class="details-section" id="detailsContactInfo">
                <div class="details-avatar" id="detailsAvatar"></div>
                <h4 id="detailsName">名称</h4>
                <p id="detailsId">ID: </p>
                <p id="detailsStatus">状态: </p>
            </section>
            <!-- AI 联系人“关于”部分 -->
            <section class="details-section" id="aiContactAboutSection">
                <h4>关于 <span id="aiContactAboutName">AI 名称</span></h4>
                <div id="aiContactDetailsContent">
                    <p><strong>基本信息</strong></p>
                    <ul id="aiContactBasicInfoList"></ul>
                    <p><strong>关于 <span id="aiContactAboutNameSub">AI 名称</span></strong></p>
                    <p id="aiContactAboutText"></p>
                </div>
            </section>
            <!-- AI 联系人“关于”部分结束 -->

            <!-- AI 记忆选择部分 -->
            <section class="details-section" id="aiChapterSection">
                <h4 id="aiChapterHeader">关卡</h4>
                <div class="settings-item">
                    <label for="aiChapterSelectContainer">选择关卡:</label> <!-- Changed for attribute -->
                    <div id="aiChapterSelectContainer">
                        <!-- Searchable select will be built here by JS -->
                    </div>
                </div>
            </section>
            <!-- AI 记忆选择部分结束 -->
            <!-- Memory Book Section -->
            <section class="details-section" id="memoryBookSection">
                <h4>记忆书</h4>
                <div id="memoryBookList">
                    <!-- Memory sets will be populated here by JS, but without management buttons -->
                </div>
            </section>
            <!-- Memory Book Section End -->

            <!-- AI TTS 配置部分 (MODIFIED STRUCTURE) -->
            <section class="details-section" id="aiTtsConfigSection">
                <!-- Main TTS Config Collapsible Container -->
                <div class="collapsible-container">
                    <h4 class="collapsible-header" id="aiTtsConfigHeader">
                        TTS 配置 <span class="collapse-icon">▶</span>
                    </h4>
                    <div class="collapsible-content tts-config-content-details" id="aiTtsConfigContent">
                        <div id="ttsConfigFormContainer">
                            <!-- TTS 设置将由 JS 在此动态填充 -->
                        </div>
                        <button id="saveAiTtsSettingsBtnDetails" class="btn btn-primary">保存 TTS 设置</button>
                    </div>
                </div>

                <!-- Attribution Collapsible Container -->
                <div class="tts-attribution-section collapsible-container">
                    <h4 class="collapsible-header attribution-sub-header" id="ttsAttributionCollapsibleTrigger">
                        更多 <span class="collapse-icon">▶</span>
                    </h4>
                    <div class="collapsible-content attribution-sub-content" id="ttsAttributionCollapsibleContent">
                        <p>
                            <strong>GPT-SoVITS开发者：</strong><a href="https://space.bilibili.com/5760446" target="_blank" rel="noopener noreferrer" >@花儿不哭</a><br>
                            <strong>TTS模型训练者：</strong><a href="https://space.bilibili.com/6589795" target="_blank" rel="noopener noreferrer" >@红血球AE3803</a>  <br><a href="https://space.bilibili.com/518098961" target="_blank" rel="noopener noreferrer" >@白菜工厂1145号员工</a><br>
                            <strong>TTS推理特化包适配者：</strong><a href="https://space.bilibili.com/1918820" target="_blank" rel="noopener noreferrer" >@AI-Hobbyist</a><br>
                            <strong>角色卡：</strong><a href="https://github.com/SillyTavern/SillyTavern" target="_blank" rel="noopener noreferrer" >SillyTavern</a><br>
                            <strong>提示词工程：</strong><a href="https://space.bilibili.com/326625155" target="_blank" rel="noopener noreferrer" >君尘陌</a><br>
                            <strong>主题概念：</strong><a href="https://space.bilibili.com/1290496974" target="_blank" rel="noopener noreferrer" >卤v</a><br>
                            <strong>素材资源：</strong><a href="#" target="_blank" rel="noopener noreferrer" >网络</a><br>
                        </p>
                        <strong>项目开源地址：</strong>
                        <ul>
                            <li><a href="https://github.com/git-hub-cc/PPMC" target="_blank" rel="noopener noreferrer" id="ttsAttributionProjectLink">https://github.com/git-hub-cc/PPMC</a><br></li>
                            <li><a href="https://gitee.com/wyswydx/PPMC" target="_blank" rel="noopener noreferrer">https://gitee.com/wyswydx/PPMC</a>
                            </li>
                        </ul>
                        <div>
                            <p>
                                项目能走到今天，离不开各位大佬的默默付出（和咖啡续命）。<br>
                                如果 PPMC 给你带来了哪怕一丝丝的快乐或便利，或者你只是单纯觉得本项目的猫猫开发者很可爱，不妨考虑请我们喝杯咖啡？<br>
                                您的每一份支持，都是我们继续爆肝更新、添加更多神奇（蛇皮）功能的动力！(づ｡◕‿‿◕｡)づ
                            </p>
                            <img src="/img/wechat/pay.png" alt="请作者喝杯咖啡" class="wechat-pay" loading="lazy">
                            <p>感谢您的慷慨！(〃'▽'〃)</p>
                        </div>
                    </div>
                </div>
            </section>
            <!-- AI TTS 配置部分结束 -->

            <!-- 群组管理部分 (MODIFIED STRUCTURE) -->
            <section class="details-section collapsible-container" id="detailsGroupManagement">
                <h4 id="groupMemberListHeader" class="collapsible-header">成员 (<span id="groupMemberCount">0</span>)<span class="collapse-icon">▶</span></h4>
                <div id="groupMemberListContainer" class="collapsible-content">
                    <div id="groupMemberListDetails" class="member-list-details"></div>
                    <div id="addGroupMemberArea" class="add-member-details">
                        <h5>添加成员 (群组上限20人)</h5>
                        <label for="contactsDropdownDetails" class="visually-hidden">选择要添加的联系人</label><select id="contactsDropdownDetails"></select>
                        <button id="addMemberBtnDetails" class="btn btn-primary">添加</button>
                    </div>
                    <div id="leftMembersArea" class="left-members-details">
                        <h5>已退出的成员</h5>
                        <div id="leftMemberListDetails"></div>
                    </div>
                </div>
            </section>
            <!-- 群组内 AI 提示词管理部分 (仅群主可见) (MODIFIED STRUCTURE) -->
            <section class="details-section collapsible-container" id="groupAiPromptsSection">
                <h4 id="groupAiPromptsHeader" class="collapsible-header">群内AI行为指示 <span class="collapse-icon">▶</span></h4>
                <div id="groupAiPromptsListContainer" class="collapsible-content">
                    <!-- AI 提示词编辑器将由 JS 在此动态填充 -->
                </div>
            </section>

            <!-- 聊天操作部分 -->
            <section class="details-section" id="currentChatActionsDetails">
                <h4>操作</h4>
                <button id="clearCurrentChatBtnDetails" class="btn btn-warning">清空聊天记录</button>
            </section>

            <!-- 群组操作部分 -->
            <section class="details-section" id="groupActionsDetails">
                <h4>群组设置</h4>
                <button id="leaveGroupBtnDetails" class="btn btn-danger">退出群组</button>
                <button id="dissolveGroupBtnDetails" class="btn btn-danger">解散群组</button>
            </section>

            <!-- 联系人设置部分 -->
            <section class="details-section" id="contactActionsDetails">
                <h4>联系人设置</h4>
                <button id="deleteContactBtnDetails" class="btn btn-danger">删除联系人</button>
            </section>
            <!-- 聊天资源预览部分 - MODIFIED -->
            <section class="details-section" id="resourcePreviewSection">
                <h4 id="resourcePreviewHeaderTitle">聊天资源</h4>
                <div id="resourcePreviewPanelContent">
                    <div class="resource-search-container">
                        <label for="resourceSearchInputDetailsPanel" class="visually-hidden">搜索资源</label><input type="search" id="resourceSearchInputDetailsPanel" placeholder="搜索资源内容..." class="search-bar">
                    </div>
                    <nav class="resource-category-tabs" id="resourceCategoryTabsContainer">
                        <button class="resource-category-tab active" data-resource-type="imagery">影像</button>
                        <button class="resource-category-tab" data-resource-type="text">文本</button>
                        <button class="resource-category-tab" data-resource-type="other">其它</button>
                        <button class="resource-category-tab" data-resource-type="date">日期</button>
                    </nav>
                    <div id="resourceGridContainer" class="resource-grid-container">
                        <!-- Resource items will be populated here by JS -->
                    </div>
                    <div id="calendarContainerDetailsPanel" class="calendar-container-rps">
                        <!-- Calendar will be rendered here by JS -->
                    </div>
                    <div id="resourceGridLoadingIndicator" class="loading-indicator-grid">
                        <div class="spinner"></div>
                    </div>
                </div>
            </section>
            <!-- 聊天资源预览部分结束 -->
        </div>
        <!-- 人员大厅内容容器 -->
        <div class="lobby-content" id="peopleLobbyContent">
            <header class="lobby-header">
                <h4>在线用户</h4>
                <button id="peopleLobbyRefreshBtn" class="icon-btn" title="刷新列表">🔄</button>
            </header>
            <ul id="peopleLobbyList" class="chat-list-container">
                <!-- 在线用户将在此处填充 -->
            </ul>
        </div>
    </aside>
</div>
<!-- 模态框 -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">连接中，请稍候...</div>
</div>
<div id="videoCallRequest" class="modal-like video-call-request">
    <div class="modal-content">
        <div class="video-call-avatar">👤</div>
        <h3>视频通话请求</h3>
        <p>来电...</p>
        <div class="video-call-request-buttons">
            <button class="btn btn-danger reject-call">拒绝</button>
            <button class="btn btn-success accept-call">接听</button>
        </div>
    </div>
</div>
<div id="callingModal" class="modal-like">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="callingModalTitle">呼叫中...</h2>
        </div>
        <div class="modal-body">
            <div class="video-call-avatar" id="callingModalAvatar">👤</div>
            <p id="callingModalText">正在联系 [对方名称]...</p>
        </div>
        <div class="modal-footer">
            <button id="callingModalCancelBtn" class="btn btn-danger">取消呼叫</button>
        </div>
    </div>
</div>
<div id="videoCallContainer" class="video-call-container-main">
    <div class="video-streams">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay playsinline muted></video>
        <!-- 音频质量指示器移到这里，使其在视频流之上 -->
        <div id="audioQualityIndicator" class="call-status-indicator">质量</div>
    </div>
    <div class="video-call-controls">
        <button class="video-call-button toggle-camera" id="toggleCameraBtn">📹</button>
        <button class="video-call-button mute-audio" id="toggleAudioBtn">🎤</button>
        <button class="video-call-button toggle-pip" id="togglePipBtn" title="画中画">↙️</button>
        <button class="video-call-button end-call" >📞</button>
        <button class="video-call-button audio-only" id="audioOnlyBtn">🔊</button>
    </div>
</div>
<!-- 主菜单 / 设置模态框 -->
<div id="mainMenuModal" class="modal-like">
    <div class="modal-content">
        <header class="modal-header">
            <h2>菜单</h2>
            <button class="icon-btn close-modal-btn" data-modal-id="mainMenuModal">✕</button>
        </header>
        <div class="modal-body">
            <nav class="menu-tabs">
                <button class="menu-tab-item active" data-tab="general">通用</button>
                <button class="menu-tab-item" data-tab="appearance">外观</button>
                <button class="menu-tab-item" data-tab="api">AI & API</button>
                <button class="menu-tab-item" data-tab="advanced">高级</button>
            </nav>

            <!-- Tab Content: General -->
            <section id="menu-tab-content-general" class="menu-tab-content active">
                <div class="settings-section">
                    <h3>您的用户 ID</h3>
                    <div class="user-id-display">
                        <span id="modalUserIdValue">生成中...</span>
                        <button id="modalCopyIdBtn" class="btn btn-secondary">复制 ID</button>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>网络状态</h3>
                    <div id="modalNetworkInfo">检测中...</div>
                    <div class="connection-quality">
                        质量: <div class="quality-indicator" id="modalQualityIndicator"></div> <span id="modalQualityText">未知</span>
                    </div>
                    <button id="checkNetworkBtnModal" class="btn btn-secondary">重新检测网络</button>
                </div>
                <div class="settings-section">
                    <h3>操作</h3>
                    <button id="modalClearContactsBtn" class="btn btn-danger">清空联系人</button>
                    <button id="modalClearAllChatsBtn" class="btn btn-danger">清空聊天记录</button>
                    <button id="modalClearCacheBtn" class="btn btn-danger">重置页面</button>
                </div>
            </section>

            <!-- Tab Content: Appearance -->
            <section id="menu-tab-content-appearance" class="menu-tab-content">
                <div class="settings-section">
                    <h3>外观设置</h3>
                    <div class="settings-item">
                        <label for="colorSchemeCustomSelectContainer">配色方案:</label>
                        <div class="custom-select" id="colorSchemeCustomSelectContainer">
                            <div class="selected" id="colorSchemeSelectedValue">自动 (浏览器)</div>
                            <div class="options" id="colorSchemeOptionsContainer"></div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label for="themeCustomSelectContainer">选择主题:</label>
                        <div class="custom-select" id="themeCustomSelectContainer">
                            <div class="selected" id="themeSelectedValue">选择一个主题</div>
                            <div class="options" id="themeOptionsContainer"></div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label for="setBackgroundBtnLight">浅色模式背景:</label>
                        <div class="setting-control-group">
                            <button id="setBackgroundBtnLight" class="btn btn-secondary btn-sm">选择图片</button>
                            <button id="removeBackgroundBtnLight" class="btn btn-danger btn-sm">移除背景</button>
                        </div>
                        <input type="file" id="bgImageInputLight" accept="image/*" class="visually-hidden">
                    </div>
                    <div class="settings-item">
                        <label for="setBackgroundBtnDark">深色模式背景:</label>
                        <div class="setting-control-group">
                            <button id="setBackgroundBtnDark" class="btn btn-secondary btn-sm">选择图片</button>
                            <button id="removeBackgroundBtnDark" class="btn btn-danger btn-sm">移除背景</button>
                        </div>
                        <input type="file" id="bgImageInputDark" accept="image/*" class="visually-hidden">
                    </div>
                </div>
            </section>

            <!-- Tab Content: AI & API -->
            <section id="menu-tab-content-api" class="menu-tab-content">
                <div class="settings-section">
                    <h3>AI & API 配置</h3>
                    <div class="settings-item">
                        <label for="llmProviderSelectContainer">大模型:</label>
                        <div class="custom-select" id="llmProviderSelectContainer">
                            <div class="selected" id="llmProviderSelectedValue">选择提供商</div>
                            <div class="options" id="llmProviderOptionsContainer"></div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label for="apiEndpointInput">API 端点:</label>
                        <input type="text" id="apiEndpointInput" placeholder="由大模型选择自动填充">
                    </div>
                    <div class="settings-item">
                        <label for="apiModelInputContainer">模型名称:</label>
                        <div id="apiModelInputContainer" class="api-model-input-container">
                            <!-- JS will create input or select here -->
                        </div>
                    </div>
                    <div class="settings-item">
                        <label for="apiKeyInput">API 密钥:</label>
                        <input type="password" id="apiKeyInput" placeholder="例如: Bearer sk-xxxx">
                    </div>
                    <div class="settings-item">
                        <label for="apiMaxTokensInput">最大令牌数:</label>
                        <input type="number" id="apiMaxTokensInput" placeholder="例如: 2048" min="1">
                    </div>
                    <div class="settings-item">
                        <label for="ttsApiEndpointInput">TTS API 端点:</label>
                        <input type="text" id="ttsApiEndpointInput" placeholder="例如: http://localhost:8000">
                    </div>
                </div>
            </section>

            <!-- Tab Content: Advanced -->
            <section id="menu-tab-content-advanced" class="menu-tab-content">
                <div class="settings-section">
                    <h3>手动连接</h3>
                    <p>用于信令服务器故障或需要直接建立连接时。</p>
                    <div class="manual-connect-step">
                        <button id="modalCreateOfferBtn" class="btn btn-secondary">1. 创建连接提议</button>
                    </div>
                    <div class="manual-connect-step">
                        <button id="modalCreateAnswerBtn" class="btn btn-secondary">2. 创建应答 (粘贴提议后)</button>
                    </div>
                    <div class="manual-connect-step">
                        <button id="modalHandleAnswerBtn" class="btn btn-secondary">3. 接受应答 (粘贴应答后)</button>
                    </div>
                    <div class="manual-connect-step">
                        <label for="modalSdpText" class="visually-hidden">连接信息</label><textarea id="modalSdpText" placeholder="在此粘贴对方的连接信息..."></textarea>
                        <button class="btn btn-secondary" id="modalCopySdpBtn">复制我的信息</button>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
<!-- 交互管理模态框 -->
<div id="newContactGroupModal" class="modal-like">
    <div class="modal-content">
        <header class="modal-header">
            <h2>交互管理</h2>
            <button class="icon-btn close-modal-btn" data-modal-id="newContactGroupModal">✕</button>
        </header>
        <div class="modal-body">
            <nav class="menu-tabs">
                <button class="menu-tab-item active" data-tab-target="#newContactTabContent">联系人</button>
                <button class="menu-tab-item" data-tab-target="#newGroupTabContent">群组</button>
                <button class="menu-tab-item" data-tab-target="#newCharacterTabContent">角色</button>
                <button class="menu-tab-item" data-tab-target="#memorySetTabContent">记忆书</button> <!-- MODIFIED -->
            </nav>

            <section id="newContactTabContent" class="menu-tab-content active">
                <div class="settings-section">
                    <h3>联系人管理</h3>
                    <p>输入对方ID。若ID已存在，可修改其昵称。若ID不存在，则添加新联系人。</p>
                    <label for="newPeerIdInput" class="visually-hidden">对方ID</label><input type="text" id="newPeerIdInput" placeholder="输入对方 ID (必填)">
                    <label for="newPeerNameInput" class="visually-hidden">对方昵称</label><input type="text" id="newPeerNameInput" placeholder="输入对方昵称 (修改或新建时可选)">
                    <button id="confirmNewContactBtn" class="btn btn-primary">添加 / 修改联系人</button>
                </div>
            </section>

            <section id="newGroupTabContent" class="menu-tab-content">
                <div class="settings-section">
                    <h3>群组管理</h3>
                    <p>输入群组名称。如果提供已存在的群组ID且您是群主，则将修改其名称；否则将创建新群组 (群组人数上限20人)。</p>
                    <label for="newGroupNameInput" class="visually-hidden">群组名称</label><input type="text" id="newGroupNameInput" placeholder="输入群组名称 (必填)">
                    <label for="newGroupIdInput" class="visually-hidden">群组ID</label><input type="text" id="newGroupIdInput" placeholder="群组 ID (可选, 留空则自动生成)">
                    <button id="confirmNewGroupBtnModal" class="btn btn-primary">创建 / 修改群组</button>
                </div>
            </section>
            <section id="newCharacterTabContent" class="menu-tab-content">
                <div class="settings-section">
                    <h3>角色卡管理</h3>
                    <p>导入和导出角色定义文件 (.json)。导入的角色将持久存在，不受主题切换影响。</p>
                    <button id="importCharacterCardBtn" class="btn btn-primary">导入角色卡</button>
                    <button id="exportThemeCharactersBtn" class="btn btn-secondary">导出当前主题角色</button>
                    <input type="file" id="characterCardInput" accept=".json" class="visually-hidden">
                </div>
            </section>
            <!-- ADDED: Memory Set Management Tab -->
            <section id="memorySetTabContent" class="menu-tab-content">
                <div class="settings-section">
                    <h3>记忆书管理</h3>
                    <p>管理用于AI提取长期记忆的关键要素。这些记忆书可用于任何AI角色。</p>
                    <div id="memorySetListContainerModal">
                        <!-- List of sets will be populated here by JS -->
                    </div>
                    <div id="memorySetFormContainerModal" style="display: none;">
                        <!-- Form for add/edit will be populated here by JS -->
                    </div>
                    <button id="showAddMemorySetFormBtn" class="btn btn-primary" style="margin-top: 15px;">+ 添加新记忆书</button>
                </div>
            </section>
        </div>
    </div>
</div>
<div id="openSourceInfoModal" class="modal-like">
    <div class="modal-content">
        <header class="modal-header">
            <h2>项目已开源！🚀</h2>
            <button class="icon-btn close-modal-btn" id="closeOpenSourceInfoModalBtn" title="关闭">✕</button>
        </header>
        <div class="modal-body">
            <p>
                PPMC 现已开源！我们很高兴能与社区分享。
            </p>
            <p>
                您可以在 GitHub 上找到源代码并参与贡献：
                <br>
                <a href="https://github.com/git-hub-cc/PPMC" target="_blank" rel="noopener noreferrer">
                    https://github.com/git-hub-cc/PPMC
                </a>
            </p>
            <p>
                如果您遇到任何问题或有建议，请在 GitHub 上提交 issue。
            </p>
            <p>
                如有紧急事宜，您可以通过微信联系我们：
            </p>
            <img src="/img/wechat/contact.png" alt="微信二维码" loading="lazy">
            <p>
                此消息将在 <span id="openSourceModalTimer">8</span> 秒后自动关闭。
            </p>
        </div>
        <footer class="modal-footer">
            <button id="permanentlyCloseOpenSourceInfoModalBtn" class="btn btn-secondary">不再显示</button>
        </footer>
    </div>
</div>

<!-- 新增截图编辑器模态框 -->
<div id="screenshotEditorModal" class="modal-like screenshot-editor-modal">
    <header class="screenshot-editor-toolbar" id="screenshotEditorToolbar">
        <button id="cropToolBtn" class="screenshot-tool-btn" title="裁剪">✂️</button>
        <button id="drawRectToolBtn" class="screenshot-tool-btn" title="矩形标记">⬜</button>
        <input type="color" id="markColorPicker" class="screenshot-tool-color-picker" title="选择标记颜色" value="#FF0000">
        <div class="toolbar-spacer"></div>
        <button id="confirmScreenshotEditBtn" class="btn btn-success">完成</button>
        <button id="cancelScreenshotEditBtn" class="btn btn-secondary">取消</button>
    </header>
    <div class="screenshot-canvas-container">
        <canvas id="screenshotEditorCanvas"></canvas>
    </div>
</div>
<!-- 截图编辑器模态框结束 -->

<!-- ========================================================================== -->
<!-- UI 组件模板 (UI Component Templates) -->
<!-- ========================================================================== -->
<template id="message-template">
    <div class="message">
        <div class="message-sender"></div>
        <div class="message-content-wrapper">
            <div class="message-content"></div>
        </div>
        <div class="timestamp"></div>
    </div>
</template>

<template id="message-file-template">
    <div class="file-info">
        <div class="thumbnail-placeholder"></div>
        <div class="file-details">
            <div class="file-name"></div>
            <div class="file-meta"></div>
        </div>
        <button class="media-action-btn"></button>
    </div>
</template>

<template id="message-audio-template">
    <div class="voice-message">
        <button class="play-voice-btn" title="播放/暂停语音">▶</button>
        <span class="voice-duration"></span>
    </div>
</template>

<template id="message-sticker-template">
    <div class="file-info sticker-info">
        <div class="thumbnail-placeholder"></div>
    </div>
</template>

<template id="chat-list-item-template">
    <li class="chat-list-item">
        <div class="chat-list-avatar"></div>
        <div class="chat-list-info">
            <div class="chat-list-name">
                <span class="name-text"></span>
                <span class="online-dot" title="已连接"></span>
            </div>
            <div class="chat-list-preview"></div>
        </div>
        <div class="chat-list-meta">
            <div class="chat-list-time"></div>
            <div class="chat-list-badge"></div>
        </div>
    </li>
</template>

<template id="group-member-item-template">
    <div class="member-item-detail">
        <span class="member-name"></span>
        <span class="owner-badge">群主</span>
        <span class="member-status"></span>
        <span class="member-actions">
            <button class="reconnect-member-btn-detail" title="重新连接">🔄</button>
            <button class="remove-member-btn-detail" title="移除成员">✕</button>
        </span>
    </div>
</template>

<template id="ai-mention-suggestion-item-template">
    <div class="mention-suggestion-item">
        <div class="mention-suggestion-avatar"></div>
        <span class="mention-suggestion-name"></span>
    </div>
</template>

<template id="notification-template">
    <div class="notification">
        <span class="notification-icon"></span>
        <span class="notification-message"></span>
        <button class="notification-close" title="关闭">×</button>
    </div>
</template>

<template id="audio-preview-template">
    <div class="voice-message-preview">
        <span>🎙️ 语音消息 (<span class="preview-duration"></span>)</span>
        <audio controls class="preview-audio-player" style="display:none;"></audio>
        <button class="btn-play-preview">播放</button>
        <button class="btn-cancel-preview">取消</button>
    </div>
</template>

<template id="file-preview-template">
    <div class="file-preview-item">
        <span class="preview-content">
            <!-- Image or Icon+Text will be inserted here -->
        </span>
        <button class="cancel-file-preview" title="移除附件">✕</button>
    </div>
</template>

<template id="resource-preview-item-template">
    <div class="resource-preview-item">
        <div class="resource-content-area">
            <!-- Thumbnail, text snippet, or file icon will be inserted here -->
        </div>
        <div class="resource-timestamp"></div>
    </div>
</template>

<script src="js/config/LLMProviders.js"></script>
<script src="js/config/McpTools.js"></script>
<!-- AppSettings 依赖 LLMProviders -->
<script src="js/config/AppSettings.js"></script>

<!-- 脚本加载顺序调整 -->
<script src="js/ThemeLoader.js"></script>
<script src="js/Utils.js"></script>
<script src="js/EventEmitter.js"></script>
<script src="js/DBManager.js"></script>
<!-- UserManager 依赖 ThemeLoader, AppSettings, Utils, EventEmitter, DBManager -->
<script src="js/UserManager.js"></script>
<!-- ConnectionManager 依赖 AppSettings, Utils, EventEmitter, UserManager -->
<script src="js/WebRTCManager.js"></script>
<script src="js/TimerManager.js"></script>
<script src="js/WebSocketManager.js"></script>
<script src="js/ConnectionManager.js"></script>
<!-- MediaManager 依赖 AppSettings, Utils, NotificationUIManager, MessageManager, MediaUIManager, EventEmitter -->
<script src="js/MediaManager.js"></script>
<!-- VideoCallManager 依赖 AppSettings, Utils, NotificationUIManager, ConnectionManager, UserManager, VideoCallUIManager, ModalUIManager -->
<script src="js/VideoCallManager.js"></script>
<!-- MessageManager 依赖 ChatManager, UserManager, ConnectionManager, GroupManager, NotificationUIManager, AiApiHandler, MediaManager, TtsApiHandler, Utils, ModalUIManager, ChatAreaUIManager, UIManager, AppSettings -->
<script src="js/MessageManager.js"></script>
<!-- ChatManager 依赖 DBManager, UserManager, GroupManager, ConnectionManager, MessageManager, DetailsPanelUIManager, ChatAreaUIManager, SidebarUIManager, NotificationUIManager, Utils, ModalUIManager -->
<script src="js/ChatManager.js"></script>
<!-- GroupManager 依赖 DBManager, UserManager, ChatManager, ConnectionManager, NotificationUIManager, Utils, DetailsPanelUIManager, ChatAreaUIManager, SidebarUIManager, MessageManager -->
<script src="js/GroupManager.js"></script>
<!-- 新增的角色卡管理器脚本 -->
<script src="js/CharacterCardManager.js"></script>

<!-- ADDED SCRIPT: EmojiStickerUIManager must be loaded before AppInitializer -->
<script src="js/UI/EmojiStickerUIManager.js"></script>
<script src="js/MemoryBookManager.js"></script>

<!-- 专业处理器/管理器 -->
<script src="js/handler/DataChannelHandler.js"></script>
<script src="js/handler/AiApiHandler.js"></script>
<script src="js/handler/TtsApiHandler.js"></script>

<!-- UI组件管理器 -->
<script src="js/UI/TtsUIManager.js"></script>
<script src="js/UI/ScreenshotEditorUIManager.js"></script>
<script src="js/UI/ModalUIManager.js"></script>
<script src="js/UI/NotificationUIManager.js"></script>
<script src="js/UI/SettingsUIManager.js"></script>
<script src="js/UI/LayoutUIManager.js"></script>
<script src="js/UI/ChatAreaUIManager.js"></script>
<script src="js/UI/SidebarUIManager.js"></script>
<script src="js/UI/DetailsPanelUIManager.js"></script>
<script src="js/UI/ResourcePreviewUIManager.js"></script>
<script src="js/UI/VideoCallUIManager.js"></script>
<script src="js/UI/MediaUIManager.js"></script>
<script src="js/PeopleLobbyManager.js"></script>

<!-- 应用初始化程序 (最后加载) -->
<script src="js/AppInitializer.js"></script>
</body>
</html>