<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Chat Modern</title>
    <link rel="stylesheet" href="css/base.css">
    <!-- Placeholder for theme-specific CSS -->
    <link id="theme-stylesheet" rel="stylesheet" href="css/åŸç¥-æ·±è‰².css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
<div class="app-container">
    <!-- Left Sidebar (Navigation) -->
    <aside class="sidebar-nav" id="sidebarNav">
        <div class="sidebar-header">
            <button class="menu-btn" id="mainMenuBtn" title="Menu">â˜°</button>
            <input type="search" class="search-bar" id="chatSearchInput" placeholder="Search...">
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab-target="all-chats" id="tabAllChats">All</button>
            <button class="nav-tab" data-tab-target="contacts-list" id="tabContacts">Contacts</button>
            <button class="nav-tab" data-tab-target="groups-list" id="tabGroups">Groups</button>
        </div>
        <div class="chat-list-container">
            <ul id="chatListNav">
                <!-- Chat items will be populated here by JS -->
                <li class="chat-list-item-empty">No chats yet.</li>
            </ul>
        </div>
        <button class="new-chat-fab" id="newChatFab" title="New Chat/Group">+</button>
    </aside>
    <!-- Main Chat Area -->
    <main class="chat-area" id="chatArea">
        <div class="chat-area-content">
            <header class="chat-header-main">
                <button class="back-to-list-btn" id="backToListBtn" title="Back to list">â†</button>
                <div class="chat-info-main">
                    <div class="chat-avatar-main" id="currentChatAvatarMain"></div>
                    <div class="chat-details-main-header">
                        <div class="chat-title-main" id="currentChatTitleMain">Select a chat</div>
                        <div class="chat-status-main" id="currentChatStatusMain"></div>
                    </div>
                </div>
                <div class="chat-actions-main">
                    <button class="header-action-btn" id="videoCallButtonMain" title="Video Call" disabled>ğŸ“¹</button>
                    <button class="header-action-btn" id="audioCallButtonMain" title="Audio Call" disabled>ğŸ¤</button>
                    <button class="header-action-btn" id="screenShareButtonMain" title="Share Screen" disabled>ğŸ–¥ï¸</button>
                    <button class="header-action-btn" id="chatDetailsBtnMain" title="Chat Info" disabled>â„¹ï¸</button>
                </div>
            </header>

            <div class="no-chat-selected" id="noChatSelectedScreen">
                <div class="logo-placeholder">ğŸ’¬</div>
                <h2>P2P Modern Chat</h2>
                <p>Select a chat from the list to start messaging, or create a new one.</p>
                <p id="connectionStatusGlobal" class="status-indicator">Status: <span id="connectionStatusText">Initializing...</span></p>
            </div>
            <div class="chat-messages-container" id="chatBox">
                <!-- Messages will be populated here. noChatSelectedScreen is no longer a child. -->
            </div>

            <footer class="chat-input-container">
                <div id="filePreviewContainer" class="file-preview-input"></div>
                <div id="audioPreviewContainer" class="audio-preview-input"></div>
                <div class="input-row">
                    <button class="icon-btn attach-btn" id="attachBtnMain" title="Attach file" disabled>ğŸ“</button>
                    <input type="file" id="fileInput" onchange="MediaManager.handleFileSelect(event)">
                    <textarea id="messageInput" placeholder="Write a message..." disabled></textarea>
                    <!-- <button class="icon-btn emoji-btn" id="emojiBtnMain" title="Emoji" disabled>ğŸ˜Š</button> -->
                    <button class="icon-btn send-btn" id="sendButtonMain" title="Send" disabled>â¤</button>
                    <button class="icon-btn record-btn" id="voiceButtonMain" title="Record voice" disabled>ğŸ™ï¸</button>
                </div>
            </footer>
        </div>
    </main>

    <!-- Right Details Panel -->
    <aside class="details-panel" id="detailsPanel">
        <header class="details-header">
            <h3 id="detailsPanelTitle">Chat Info</h3>
            <button class="icon-btn close-details-btn" id="closeDetailsBtnMain" title="Close details">âœ•</button>
        </header>
        <div class="details-content" id="detailsPanelContent">
            <div class="details-section" id="detailsContactInfo">
                <div class="details-avatar" id="detailsAvatar"></div>
                <h4 id="detailsName">Name</h4>
                <p id="detailsId">ID: </p>
                <p id="detailsStatus">Status: </p>
            </div>
            <!-- AI Contact About Section -->
            <div class="details-section" id="aiContactAboutSection" style="display: none;">
                <h4>About <span id="aiContactAboutName">AI Name</span></h4>
                <div id="aiContactDetailsContent">
                    <p><strong>åŸºæœ¬ä¿¡æ¯</strong></p>
                    <ul id="aiContactBasicInfoList"></ul>
                    <p><strong>å…³äº <span id="aiContactAboutNameSub">AI Name</span></strong></p>
                    <p id="aiContactAboutText"></p>
                </div>
            </div>
            <!-- End AI Contact About Section -->
            <!-- AI TTS Configuration Section -->
            <div class="details-section" id="aiTtsConfigSection" style="display: none;">
                <h4 class="collapsible-header" id="aiTtsConfigHeader">
                    TTS Configuration <span class="collapse-icon">â–¶</span>
                </h4>
                <div class="collapsible-content tts-config-content-details" id="aiTtsConfigContent" style="display: none;">
                    <div id="ttsConfigFormContainer">
                        <!-- TTS settings will be dynamically populated here by JS -->
                    </div>
                    <button id="saveAiTtsSettingsBtnDetails" class="btn btn-primary" style="margin-top: 15px; width: 100%;">Save TTS Settings</button>
                </div>
                <div class="tts-attribution-section">
                    <p>
                        <strong>GPT-SoVITS å¼€å‘è€…ï¼š</strong><a href="https://space.bilibili.com/5760446" target="_blank" rel="noopener noreferrer" >@èŠ±å„¿ä¸å“­</a><br>
                        <strong>æ¨¡å‹è®­ç»ƒè€…ï¼š</strong><a href="https://space.bilibili.com/6589795" target="_blank" rel="noopener noreferrer" >@çº¢è¡€çƒAE3803</a>  <a href="https://space.bilibili.com/518098961" target="_blank" rel="noopener noreferrer" >@ç™½èœå·¥å‚1145å·å‘˜å·¥</a><br>
                        <strong>æ¨ç†ç‰¹åŒ–åŒ…é€‚é… & åœ¨çº¿æ¨ç†ï¼š</strong><a href="https://gsv.acgnai.top/" target="_blank" rel="noopener noreferrer" >@AI-Hobbyist</a><br>
                        <a href="https://gsv.acgnai.top/" target="_blank" rel="noopener noreferrer" >ç½‘ç«™é¢„è§ˆ</a><br>
                        <strong>å½“å‰é¡¹ç›®å¼€æºåœ°å€ï¼š</strong><a href="https://github.com/git-hub-cc/P2P-Web-Chat" target="_blank" rel="noopener noreferrer" id="ttsAttributionProjectLink">https://github.com/git-hub-cc/P2P-Web-Chat</a>
                    </p>
                </div>
            </div>
            <!-- End AI TTS Configuration Section -->
            <!-- Chat Actions Section -->
            <div class="details-section" id="currentChatActionsDetails" style="display: none;">
                <h4>Chat Actions</h4>
                <button id="clearCurrentChatBtnDetails" class="btn btn-warning">Clear Chat History</button>
            </div>
            <!-- Contact Settings Section -->
            <div class="details-section" id="contactActionsDetails" style="display: none;">
                <h4>Contact Settings</h4>
                <button id="deleteContactBtnDetails" class="btn btn-danger">Delete Contact</button>
            </div>
            <!-- Group Management Section -->
            <div class="details-section" id="detailsGroupManagement" style="display: none;">
                <h4>Members (<span id="groupMemberCount">0</span>)</h4>
                <div id="groupMemberListDetails" class="member-list-details"></div>
                <div id="addGroupMemberArea" class="add-member-details" style="display: none;">
                    <h5>Add Member</h5>
                    <select id="contactsDropdownDetails"></select>
                    <button id="addMemberBtnDetails" class="btn btn-primary">Add</button>
                </div>
                <div id="leftMembersArea" class="left-members-details" style="display: none;">
                    <h5>Previously Left Members</h5>
                    <div id="leftMemberListDetails"></div>
                </div>
            </div>
            <div class="details-section" id="groupActionsDetails" style="display: none;">
                <h4>Group Settings</h4>
                <button id="leaveGroupBtnDetails" class="btn btn-danger">Leave Group</button>
                <button id="dissolveGroupBtnDetails" class="btn btn-danger">Dissolve Group</button>
            </div>
        </div>
    </aside>
</div>
<!-- Modals -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Connecting, please wait...</div>
</div>
<div id="videoCallRequest" class="modal-like video-call-request">
    <div class="modal-content">
        <div class="video-call-avatar">ğŸ‘¤</div>
        <h3>Video Call Request</h3>
        <p>Incoming call...</p>
        <div class="video-call-request-buttons">
            <button class="btn btn-danger reject-call" onclick="VideoCallManager.rejectCall()">Reject</button>
            <button class="btn btn-success accept-call" onclick="VideoCallManager.acceptCall()">Accept</button>
        </div>
    </div>
</div>
<div id="callingModal" class="modal-like">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="callingModalTitle">Calling...</h2>
        </div>
        <div class="modal-body">
            <div class="video-call-avatar" id="callingModalAvatar">ğŸ‘¤</div>
            <p id="callingModalText">Contacting [Peer Name]...</p>
        </div>
        <div class="modal-footer">
            <button id="callingModalCancelBtn" class="btn btn-danger">Cancel Call</button>
        </div>
    </div>
</div>
<div id="videoCallContainer" class="video-call-container-main">
    <div class="video-streams">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <div class="video-call-controls">
        <button class="video-call-button toggle-camera" id="toggleCameraBtn" onclick="VideoCallManager.toggleCamera()">ğŸ“¹</button>
        <button class="video-call-button mute-audio" id="toggleAudioBtn" onclick="VideoCallManager.toggleAudio()">ğŸ¤</button>
        <button class="video-call-button toggle-pip" id="togglePipBtn" title="Minimize Video">ğŸ–¼ï¸</button>
        <button class="video-call-button end-call" onclick="VideoCallManager.endCall()">ğŸ“</button>
        <button class="video-call-button audio-only" id="audioOnlyBtn" onclick="VideoCallManager.toggleAudioOnly()">ğŸ”Š</button>
    </div>
</div>
<!-- Main Menu / Settings Modal -->
<div id="mainMenuModal" class="modal-like">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Menu & Settings</h2>
            <button class="icon-btn close-modal-btn" data-modal-id="mainMenuModal">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="settings-section">
                <h3>Your User ID</h3>
                <div class="user-id-display">
                    <span id="modalUserIdValue">Generating...</span>
                    <button id="modalCopyIdBtn" class="btn btn-secondary">Copy ID</button>
                </div>
            </div>
            <div class="settings-section">
                <h3>Theme</h3>
                <div class="settings-item">
                    <label for="colorSchemeCustomSelectContainer">Color Scheme:</label>
                    <div class="custom-select" id="colorSchemeCustomSelectContainer">
                        <div class="selected" id="colorSchemeSelectedValue">Auto (System)</div>
                        <div class="options" id="colorSchemeOptionsContainer">
                        </div>
                    </div>
                </div>
                <div class="settings-item">
                    <label for="themeCustomSelectContainer">Select Theme:</label>
                    <div class="custom-select" id="themeCustomSelectContainer">
                        <div class="selected" id="themeSelectedValue">Select a Theme</div>
                        <div class="options" id="themeOptionsContainer">
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3 class="collapsible-header">
                    AI & API Configuration <span class="collapse-icon">â–¶</span>
                </h3>
                <div class="collapsible-content" style="display: none;"> <!-- Initially collapsed -->
                    <div class="settings-item">
                        <label for="apiEndpointInput">API Endpoint:</label>
                        <input type="text" id="apiEndpointInput" placeholder="e.g., https://api.openai.com/v1/chat/completions">
                    </div>
                    <div class="settings-item">
                        <label for="apiKeyInput">API Key:</label>
                        <input type="password" id="apiKeyInput" placeholder="e.g., Bearer sk-xxxx">
                    </div>
                    <div class="settings-item">
                        <label for="apiModelInput">Model Name:</label>
                        <input type="text" id="apiModelInput" placeholder="e.g., gpt-4o">
                    </div>
                    <div class="settings-item">
                        <label for="apiMaxTokensInput">Max Tokens:</label>
                        <input type="number" id="apiMaxTokensInput" placeholder="e.g., 1000" min="1">
                    </div>
                    <div class="settings-item">
                        <label for="ttsApiEndpointInput">TTS API Endpoint:</label>
                        <input type="text" id="ttsApiEndpointInput"
                               placeholder="e.g., http://localhost:8000/infer_single">
                    </div>
                    <h4 class="collapsible-header">
                        Advanced <span class="collapse-icon">â–¶</span>
                    </h4>
                    <div class="collapsible-content" style="display: none;">
                        <p>For connecting if signaling server fails or for direct peer connection.</p>
                        <div class="manual-connect-step">
                            <button onclick="ConnectionManager.createOffer(null, { isManual: true })" id="modalCreateOfferBtn" class="btn">1. Create Offer</button>
                        </div>
                        <div class="manual-connect-step">
                            <button onclick="ConnectionManager.createAnswer({ isManual: true })" id="modalCreateAnswerBtn" class="btn">2. Create Answer (after pasting offer)</button>
                        </div>
                        <div class="manual-connect-step">
                            <button onclick="ConnectionManager.handleAnswer({ isManual: true })" id="modalHandleAnswerBtn" class="btn">3. Accept Answer (after pasting answer)</button>
                        </div>
                        <div class="manual-connect-step">
                            <label for="modalSdpText"></label><textarea id="modalSdpText" placeholder="Paste peer's connection info here..."></textarea>
                            <button onclick="SettingsUIManager.copySdpTextFromModal()" class="btn btn-secondary" id="modalCopySdpBtn">Copy My Info</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="settings-section">
                <h3>Preferences</h3>
                <div class="settings-item">
                    <label for="autoConnectToggle">Auto-connect:</label>
                    <label class="switch">
                        <input type="checkbox" id="autoConnectToggle">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
            <div class="settings-section">
                <h3>Network Status</h3>
                <div id="modalNetworkInfo">Detecting...</div>
                <div class="connection-quality">
                    Quality: <div class="quality-indicator" id="modalQualityIndicator"></div> <span id="modalQualityText">N/A</span>
                </div>
                <button id="checkNetworkBtnModal" class="btn btn-secondary">Re-check Network</button>
            </div>
            <div class="settings-section">
                <h3>Danger Zone</h3>
                <button id="modalResetAllConnectionsBtn" class="btn btn-danger">Reset All Connections</button>
                <button id="modalClearContactsBtn" class="btn btn-danger">Clear All Contacts</button>
                <button id="modalClearAllChatsBtn" class="btn btn-danger">Clear All Chat History</button>
            </div>
        </div>
    </div>
</div>
<!-- New Chat/Group Modal -->
<div id="newContactGroupModal" class="modal-like">
    <div class="modal-content">
        <div class="modal-header">
            <h2>New Chat / Group</h2>
            <button class="icon-btn close-modal-btn" data-modal-id="newContactGroupModal">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="settings-section">
                <h3>Add New Contact</h3>
                <input type="text" id="newPeerIdInput" placeholder="Enter Peer ID">
                <input type="text" id="newPeerNameInput" placeholder="Enter Peer Nickname (Optional)">
                <button id="confirmNewContactBtn" class="btn btn-primary">Add Contact</button>
            </div>
            <hr>
            <div class="settings-section">
                <h3>Create New Group</h3>
                <input type="text" id="newGroupNameInput" placeholder="Enter Group Name">
                <button id="confirmNewGroupBtnModal" class="btn btn-primary">Create Group</button>
            </div>
        </div>
    </div>
</div>
<div id="openSourceInfoModal" class="modal-like">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Project Open Source! ğŸš€</h2>
            <button class="icon-btn close-modal-btn" id="closeOpenSourceInfoModalBtn" title="Close">âœ•</button>
        </div>
        <div class="modal-body" style="text-align: center;">
            <p>
                P2P-Web-Chat is now open source! We're excited to share it with the community.
            </p>
            <p>
                You can find the source code and contribute on GitHub:
                <br>
                <a href="https://github.com/git-hub-cc/P2P-Web-Chat" target="_blank" rel="noopener noreferrer">
                    https://github.com/git-hub-cc/P2P-Web-Chat
                </a>
            </p>
            <p>
                If you encounter any issues or have suggestions, please open an issue on GitHub.
            </p>
            <p>
                For urgent matters, you can reach out via WeChat:
            </p>
            <img src="/img/wechat.png" alt="WeChat QR Code" style="max-width: 150px; margin: 10px auto; display: block; border: 1px solid var(--border-color);">
            <p style="font-size: 0.9em; color: var(--text-color-light);">
                This message will auto-close in <span id="openSourceModalTimer">15</span> seconds.
            </p>
        </div>
        <div class="modal-footer">
            <button id="permanentlyCloseOpenSourceInfoModalBtn" class="btn btn-secondary">Don't Show Again</button>
        </div>
    </div>
</div>
<script>
    window.SPECIAL_CONTACTS_DEFINITIONS = [];
</script>
<!-- Main application scripts -->
<script src="config/Config.js"></script> <!-- Config should be early -->

<!-- Utilities -->
<script src="js/Utils.js"></script>
<script src="js/EventEmitter.js"></script>
<script src="js/DBManager.js"></script>

<!-- Core Logic Managers -->
<script src="js/UserManager.js"></script>
<script src="js/ConnectionManager.js"></script>
<script src="js/MediaManager.js"></script> <!-- Core Media Logic -->
<script src="js/VideoCallManager.js"></script> <!-- Core Video Call Logic -->
<script src="js/MessageManager.js"></script> <!-- Core Message Logic -->
<script src="js/ChatManager.js"></script>
<script src="js/GroupManager.js"></script>

<!-- Specialized Handlers/Managers (often used by core logic or specific UI parts) -->
<script src="js/MessageTtsHandler.js"></script>
<script src="js/TtsUIManager.js"></script> <!-- For Details Panel TTS Config Form -->

<!-- UI Component Managers -->
<script src="js/UIManager.js"></script> <!-- Slimmed down UIManager -->
<script src="js/ModalManager.js"></script>
<script src="js/NotificationManager.js"></script>
<script src="js/SettingsUIManager.js"></script>
<script src="js/LayoutManager.js"></script>
<script src="js/ChatAreaUIManager.js"></script>
<script src="js/SidebarUIManager.js"></script>
<script src="js/DetailsPanelUIManager.js"></script>
<script src="js/VideoCallUIManager.js"></script> <!-- Video Call specific UI -->
<script src="js/MediaUIManager.js"></script> <!-- Media Previews UI -->

<!-- Theme Loader (loads theme CSS and data JS with SPECIAL_CONTACTS_DEFINITIONS) -->
<script src="js/ThemeLoader.js"></script>

<!-- App Initializer (should be last or near last) -->
<script src="js/AppInitializer.js"></script>
</body>
</html>